/* LGPL @author Dmitry Koterov, http://en.dklab.ru/lib/JsHttpRequest/ @version 5.x $Id$ */ function JsHttpRequest(){this.onreadystatechange=null;this.readyState=0;this.responseXML=this.responseText=null;this.status=200;this.statusText="OK";this.responseJS=null;this.caching=!1;this.loader=null;this.session_name="PHPSESSID";this._ldObj=null;this._reqHeaders=[];this._openArgs=null;this._errors={inv_form_el:"Invalid FORM element detected: name=%, tag=%",must_be_single_el:"If used, <form> must be a single HTML element in the list.",js_invalid:"JavaScript code generated by backend is invalid!\n%", url_too_long:"Cannot use so long query with GET request (URL is larger than % bytes)",unk_loader:"Unknown loader: %",no_loaders:"No loaders registered at all, please check JsHttpRequest.LOADERS array",no_loader_matched:"Cannot find a loader which may process the request. Notices are:\n%"};this.abort=function(){with(this){_ldObj&&_ldObj.abort&&_ldObj.abort();_cleanup();if(0==readyState)return;if(1==readyState&&!_ldObj){readyState=0;return}_changeReadyState(4,!0)}};this.open=function(a,b,d,c,e){with(this){b.match(/^((\w+)\.)?(GET|POST)\s+(.*)/i)&& (this.loader=RegExp.$2?RegExp.$2:null,a=RegExp.$3,b=RegExp.$4);try{if(document.location.search.match(RegExp("[&?]"+session_name+"=([^&?]*)"))||document.cookie.match(RegExp("(?:;|^)\\s*"+session_name+"=([^;]*)")))b+=(0<=b.indexOf("?")?"&":"?")+session_name+"="+this.escape(RegExp.$1)}catch(f){}_openArgs={method:(a||"").toUpperCase(),url:b,asyncFlag:d,username:null!=c?c:"",password:null!=e?e:""};_ldObj=null;_changeReadyState(1,!0);return!0}};this.send=function(a){if(this.readyState){this._changeReadyState(1, !0);this._ldObj=null;var b=[],d=[];if(this._hash2query(a,null,b,d)){a=null;if(this.caching&&!d.length){var a=this._openArgs.username+":"+this._openArgs.password+"@"+this._openArgs.url+"|"+b+"#"+this._openArgs.method,c=JsHttpRequest.CACHE[a];if(c)return this._dataReady(c[0],c[1]),!1}if((c=(this.loader||"").toLowerCase())&&!JsHttpRequest.LOADERS[c])return this._error("unk_loader",c);var e=[],f=JsHttpRequest.LOADERS,g;for(g in f){var h=f[g].loader;if(h&&!(c&&g!=c)){h=new h(this);JsHttpRequest.extend(h, this._openArgs);JsHttpRequest.extend(h,{queryText:b.join("&"),queryElem:d,id:(new Date).getTime()+""+JsHttpRequest.COUNT++,hash:a,span:null});var i=h.load();if(!i)return this._ldObj=h,JsHttpRequest.PENDING[h.id]=this,!0;if(c)return this._error(i);e[e.length]="- "+g.toUpperCase()+": "+this._l(i)}}return g?this._error("no_loader_matched",e.join("\n")):this._error("no_loaders")}}};this.getAllResponseHeaders=function(){with(this)return _ldObj&&_ldObj.getAllResponseHeaders?_ldObj.getAllResponseHeaders(): []};this.getResponseHeader=function(a){with(this)return _ldObj&&_ldObj.getResponseHeader?_ldObj.getResponseHeader(a):null};this.setRequestHeader=function(a,b){with(this)_reqHeaders[_reqHeaders.length]=[a,b]};this._dataReady=function(a,b){with(this)caching&&_ldObj&&(JsHttpRequest.CACHE[_ldObj.hash]=[a,b]),responseText=responseXML=a,responseJS=b,null!==b?(status=200,statusText="OK"):(status=500,statusText="Internal Server Error"),_changeReadyState(2),_changeReadyState(3),_changeReadyState(4),_cleanup()}; this._l=function(a){for(var b=0,d=0,c=this._errors[a[0]];0<=(d=c.indexOf("%",d));)var e=a[++b]+"",c=c.substring(0,d)+e+c.substring(d+1,c.length),d=d+(1+e.length);return c};this._error=function(a){a=this._l("string"==typeof a?arguments:a);a="JsHttpRequest: "+a;if(window.Error){if("test"==Error(1,"test").description)throw Error(1,a);throw Error(a);}throw a;};this._hash2query=function(a,b,d,c){null==b&&(b="");if("object"==(""+typeof a).toLowerCase()){var e=!1;a&&a.parentNode&&a.parentNode.appendChild&& a.tagName&&"FORM"==a.tagName.toUpperCase()&&(a={form:a});for(var f in a){var g=a[f];if(!(g instanceof Function)){var h=b?b+"["+this.escape(f)+"]":this.escape(f);if(g&&g.parentNode&&g.parentNode.appendChild&&g.tagName){var i=g.tagName.toUpperCase();if("FORM"==i)e=!0;else if(!("INPUT"==i||"TEXTAREA"==i||"SELECT"==i))return this._error("inv_form_el",g.name||"",g.tagName);c[c.length]={name:h,e:g}}else if(g instanceof Object)this._hash2query(g,h,d,c);else{if(null===g)continue;!0===g&&(g=1);!1===g&&(g= "");d[d.length]=h+"="+this.escape(""+g)}if(e&&1<c.length)return this._error("must_be_single_el")}}}else d[d.length]=a;return!0};this._cleanup=function(){var a=this._ldObj;if(a){JsHttpRequest.PENDING[a.id]=!1;var b=a.span;b&&(a.span=null,JsHttpRequest.setTimeout(function(){b.parentNode.removeChild(b)},50))}};this._changeReadyState=function(a,b){with(this)b&&(status=statusText=responseJS=null,responseText=""),readyState=a,onreadystatechange&&onreadystatechange()};this.escape=function(a){return escape(a).replace(RegExp("\\+", "g"),"%2B")}}JsHttpRequest.COUNT=0;JsHttpRequest.MAX_URL_LEN=2E3;JsHttpRequest.CACHE={};JsHttpRequest.PENDING={};JsHttpRequest.LOADERS={};JsHttpRequest._dummy=function(){};JsHttpRequest.TIMEOUTS={s:window.setTimeout,c:window.clearTimeout}; JsHttpRequest.setTimeout=function(a,b){window.JsHttpRequest_tmp=JsHttpRequest.TIMEOUTS.s;if("string"==typeof a)d=window.JsHttpRequest_tmp(a,b);else{var d=null,c=function(){a();delete JsHttpRequest.TIMEOUTS[d]},d=window.JsHttpRequest_tmp(c,b);JsHttpRequest.TIMEOUTS[d]=c}window.JsHttpRequest_tmp=null;return d};JsHttpRequest.clearTimeout=function(a){window.JsHttpRequest_tmp=JsHttpRequest.TIMEOUTS.c;delete JsHttpRequest.TIMEOUTS[a];a=window.JsHttpRequest_tmp(a);window.JsHttpRequest_tmp=null;return a}; JsHttpRequest.query=function(a,b,d,c){var e=new this;e.caching=!c;e.onreadystatechange=function(){4==e.readyState&&d(e.responseJS,e.responseText)};e.open(null,a,!0);e.send(b)};JsHttpRequest.dataReady=function(a){var b=this.PENDING[a.id];delete this.PENDING[a.id];if(b)b._dataReady(a.text,a.js);else if(!1!==b)throw"dataReady(): unknown pending id: "+a.id;};JsHttpRequest.extend=function(a,b){for(var d in b)a[d]=b[d]}; JsHttpRequest.LOADERS.xml={loader:function(a){JsHttpRequest.extend(a._errors,{xml_no:"Cannot use XMLHttpRequest or ActiveX loader: not supported",xml_no_diffdom:"Cannot use XMLHttpRequest to load data from different domain %",xml_no_headers:"Cannot use XMLHttpRequest loader or ActiveX loader, POST method: headers setting is not supported, needed to work with encodings correctly",xml_no_form_upl:"Cannot use XMLHttpRequest loader: direct form elements using and uploading are not implemented"});this.load= function(){if(this.queryElem.length)return["xml_no_form_upl"];if(this.url.match(/^([a-z]+:\/\/[^\/]+)(.*)/i)&&RegExp.$1.toLowerCase()!=document.location.protocol+"//"+document.location.hostname.toLowerCase())return["xml_no_diffdom",RegExp.$1];var b=null;if(window.XMLHttpRequest)try{b=new XMLHttpRequest}catch(d){}else if(window.ActiveXObject){try{b=new ActiveXObject("Microsoft.XMLHTTP")}catch(c){}if(!b)try{b=new ActiveXObject("Msxml2.XMLHTTP")}catch(e){}}if(!b)return["xml_no"];var f=window.ActiveXObject|| b.setRequestHeader;this.method||(this.method=f&&this.queryText.length?"POST":"GET");if("GET"==this.method){if(this.queryText&&(this.url+=(0<=this.url.indexOf("?")?"&":"?")+this.queryText),this.queryText="",this.url.length>JsHttpRequest.MAX_URL_LEN)return["url_too_long",JsHttpRequest.MAX_URL_LEN]}else if("POST"==this.method&&!f)return["xml_no_headers"];this.url+=(0<=this.url.indexOf("?")?"&":"?")+"JsHttpRequest="+(a.caching?"0":this.id)+"-xml";var g=this.id;b.onreadystatechange=function(){if(b.readyState== 4){b.onreadystatechange=JsHttpRequest._dummy;a.status=null;try{a.status=b.status;a.responseText=b.responseText}catch(c){}if(a.status){try{eval("JsHttpRequest._tmp = function(id) { var d = "+a.responseText+"; d.id = id; JsHttpRequest.dataReady(d); }")}catch(d){return a._error("js_invalid",a.responseText)}JsHttpRequest._tmp(g);JsHttpRequest._tmp=null}}};b.open(this.method,this.url,!0,this.username,this.password);if(f){for(f=0;f<a._reqHeaders.length;f++)b.setRequestHeader(a._reqHeaders[f][0],a._reqHeaders[f][1]); b.setRequestHeader("Content-Type","application/octet-stream")}b.send(this.queryText);this.span=null;this.xr=b;return null};this.getAllResponseHeaders=function(){return this.xr.getAllResponseHeaders()};this.getResponseHeader=function(b){return this.xr.getResponseHeader(b)};this.abort=function(){this.xr.abort();this.xr=null}}}; JsHttpRequest.LOADERS.script={loader:function(a){JsHttpRequest.extend(a._errors,{script_only_get:"Cannot use SCRIPT loader: it supports only GET method",script_no_form:"Cannot use SCRIPT loader: direct form elements using and uploading are not implemented"});this.load=function(){this.queryText&&(this.url+=(0<=this.url.indexOf("?")?"&":"?")+this.queryText);this.url+=(0<=this.url.indexOf("?")?"&":"?")+"JsHttpRequest="+this.id+"-script";this.queryText="";this.method||(this.method="GET");if("GET"!==this.method)return["script_only_get"]; if(this.queryElem.length)return["script_no_form"];if(this.url.length>JsHttpRequest.MAX_URL_LEN)return["url_too_long",JsHttpRequest.MAX_URL_LEN];var b=this,a=document,c=null,e=a.body;window.opera?(this.span=c=a.createElement("SPAN"),c.style.display="none",e.insertBefore(c,e.lastChild),c.innerHTML="Workaround for IE.<script><\/script>",a=function(){c=c.getElementsByTagName("SCRIPT")[0];c.language="JavaScript";c.setAttribute?c.setAttribute("src",b.url):c.src=b.url}):(this.span=c=a.createElement("SCRIPT"), a=function(){c.language="JavaScript";c.setAttribute?c.setAttribute("src",b.url):c.src=b.url;e.insertBefore(c,e.lastChild)});JsHttpRequest.setTimeout(a,10);return null}}}; JsHttpRequest.LOADERS.form={loader:function(a){JsHttpRequest.extend(a._errors,{form_el_not_belong:'Element "%" does not belong to any form!',form_el_belong_diff:'Element "%" belongs to a different form. All elements must belong to the same form!',form_el_inv_enctype:'Attribute "enctype" of the form must be "%" (for IE), "%" given.'});this.load=function(){var b=this;b.method||(b.method="POST");b.url+=(0<=b.url.indexOf("?")?"&":"?")+"JsHttpRequest="+b.id+"-form";if("GET"==b.method){b.queryText&&(b.url+= (0<=b.url.indexOf("?")?"&":"?")+b.queryText);if(b.url.length>JsHttpRequest.MAX_URL_LEN)return["url_too_long",JsHttpRequest.MAX_URL_LEN];var a=b.url.split("?",2);b.url=a[0];b.queryText=a[1]||""}var c=null,e=!1;if(b.queryElem.length){if("FORM"==b.queryElem[0].e.tagName.toUpperCase())c=b.queryElem[0].e,e=!0,b.queryElem=[];else{c=b.queryElem[0].e.form;for(a=0;a<b.queryElem.length;a++){var f=b.queryElem[a].e;if(!f.form)return["form_el_not_belong",f.name];if(f.form!=c)return["form_el_belong_diff",f.name]}}if("POST"== b.method&&(a=c.attributes.encType&&c.attributes.encType.nodeValue||c.attributes.enctype&&c.attributes.enctype.value||c.enctype,"multipart/form-data"!=a))return["form_el_inv_enctype","multipart/form-data",a]}var g=c&&(c.ownerDocument||c.document)||document,h="jshr_i_"+b.id,a=b.span=g.createElement("DIV");a.style.position="absolute";a.style.display="none";a.style.visibility="hidden";a.innerHTML=(c?"":"<form"+("POST"==b.method?' enctype="multipart/form-data" method="post"':"")+"></form>")+'<iframe name="'+ h+'" id="'+h+'" style="width:0px; height:0px; overflow:hidden; border:none"></iframe>';c||(c=b.span.firstChild);g.body.insertBefore(a,g.body.lastChild);var i=function(a,b){var c=[],d=a;if(a.mergeAttributes){d=g.createElement("form");d.mergeAttributes(a,false)}for(var e=0;e<b.length;e++){var f=b[e][0],h=b[e][1];c[c.length]=[f,d.getAttribute(f)];d.setAttribute(f,h)}a.mergeAttributes&&a.mergeAttributes(d,false);return c};JsHttpRequest.setTimeout(function(){top.JsHttpRequestGlobal=JsHttpRequest;var a= [];if(!e)for(var d=0,f=c.elements.length;d<f;d++){a[d]=c.elements[d].name;c.elements[d].name=""}f=b.queryText.split("&");for(d=f.length-1;d>=0;d--){var k=f[d].split("=",2),j=g.createElement("INPUT");j.type="hidden";j.name=unescape(k[0]);j.value=k[1]!=null?unescape(k[1]):"";c.appendChild(j)}for(d=0;d<b.queryElem.length;d++)b.queryElem[d].e.name=b.queryElem[d].name;d=i(c,[["action",b.url],["method",b.method],["onsubmit",null],["target",h]]);c.submit();i(c,d);for(d=0;d<f.length;d++)c.lastChild.parentNode.removeChild(c.lastChild); if(!e){d=0;for(f=c.elements.length;d<f;d++)c.elements[d].name=a[d]}},100);return null}}};